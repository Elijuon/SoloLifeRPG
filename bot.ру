import telebot
from telebot import types
import sqlite3
import json

# --- 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ ---
bot = telebot.TeleBot("8116032969:AAGa-05A_4lJfeh5mkRXk132-6Wk-1awNAg")  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ç–æ–∫–µ–Ω –æ—Ç @BotFather

# --- 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ---
def init_db():
    """–°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤"""
    conn = sqlite3.connect('game.db')
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS players (
            user_id INTEGER PRIMARY KEY,
            name TEXT,
            avatar TEXT,
            xp INTEGER DEFAULT 0,
            level INTEGER DEFAULT 1,
            completed_quests TEXT DEFAULT '[]'
        )
    ''')
    conn.commit()
    conn.close()

# --- 3. –ö–æ–º–∞–Ω–¥–∞ /start ---
@bot.message_handler(commands=['start'])
def start(message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start —Å –∫–Ω–æ–ø–∫–æ–π WebApp"""
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∏–≥—Ä—ã
    button = types.KeyboardButton(
        text="üéÆ –û—Ç–∫—Ä—ã—Ç—å –∏–≥—Ä—É", 
        web_app=types.WebAppInfo(url="https://elijuon.github.io/SoloLifeRPG/")
    )
    markup.add(button)
    
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    bot.send_message(
        chat_id=message.chat.id,
        text="""–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SoloLifeRPG! 
–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É.""",
        reply_markup=markup
    )

# --- 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ WebApp ---
@bot.message_handler(content_types=['web_app_data'])
def handle_web_app(message):
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏–≥—Ä—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å"""
    try:
        data = json.loads(message.web_app_data.data)
        user_id = message.chat.id
        
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ë–î
        conn = sqlite3.connect('game.db')
        cursor = conn.cursor()
        
        # --- 4.1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ---
        if data.get('action') == 'create_character':
            cursor.execute('''
                INSERT OR REPLACE INTO players 
                (user_id, name, avatar, xp, level) 
                VALUES (?, ?, ?, 0, 1)
            ''', (user_id, data['name'], data['avatar']))
            
            bot.send_message(
                user_id, 
                f"üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂ {data['name']} —Å–æ–∑–¥–∞–Ω! –û—Ç–∫—Ä–æ–π—Ç–µ –∏–≥—Ä—É —Å–Ω–æ–≤–∞."
            )
        
        # --- 4.2. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞ ---
        elif data.get('action') == 'complete_quest':
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
            cursor.execute('SELECT * FROM players WHERE user_id = ?', (user_id,))
            player = cursor.fetchone()
            
            if player:
                # –û–±–Ω–æ–≤–ª—è–µ–º XP –∏ —É—Ä–æ–≤–µ–Ω—å
                new_xp = player[3] + data['xp']
                new_level = player[4]
                
                if new_xp >= 100:
                    new_level += 1
                    new_xp = 0
                    bot.send_message(user_id, f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —É—Ä–æ–≤–Ω—è {new_level}!")
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤
                completed_quests = json.loads(player[5])
                completed_quests.append(data['questId'])
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
                cursor.execute('''
                    UPDATE players 
                    SET xp = ?, level = ?, completed_quests = ?
                    WHERE user_id = ?
                ''', (new_xp, new_level, json.dumps(completed_quests), user_id))
                
                bot.send_message(
                    user_id, 
                    f"‚úÖ –ö–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω! +{data['xp']} XP."
                )
        
        conn.commit()
        conn.close()
        
    except Exception as e:
        print("–û—à–∏–±–∫–∞:", e)
        bot.send_message(message.chat.id, "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

# --- 5. –ö–æ–º–∞–Ω–¥–∞ /profile ---
@bot.message_handler(commands=['profile'])
def profile(message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–≥—Ä–æ–∫–∞"""
    conn = sqlite3.connect('game.db')
    cursor = conn.cursor()
    cursor.execute('SELECT name, xp, level FROM players WHERE user_id = ?', (message.chat.id,))
    player = cursor.fetchone()
    
    if player:
        name, xp, level = player
        bot.send_message(
            message.chat.id,
            f"""üìä –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:
üë§ –ò–º—è: {name}
‚ö° XP: {xp}/100
üèÜ –£—Ä–æ–≤–µ–Ω—å: {level}"""
        )
    else:
        bot.send_message(
            message.chat.id, 
            "–í—ã –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞! –ù–∞–∂–º–∏—Ç–µ /start."
        )
    
    conn.close()

# --- 6. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ---
if __name__ == "__main__":
    init_db()  # –°–æ–∑–¥–∞–µ–º –ë–î –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    bot.polling()
